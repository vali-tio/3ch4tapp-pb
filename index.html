<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Santai v7</title>
<style>
    body {font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; display: flex; flex-direction: column; height: 100vh;}
    #messages {flex: 1; overflow-y: auto; padding: 10px; background: white; display: flex; flex-direction: column;}
    .message {background: #e1ffc7; padding: 8px 12px; border-radius: 12px; margin: 6px 0; max-width: 80%; word-wrap: break-word; align-self: flex-start;}
    .my-message {background: #c7e1ff; align-self: flex-end;}
    .msg-time {font-size: 10px; color: #555; display: block; text-align: right; margin-top: 4px;}
    #input-area {background: #ddd; padding: 10px; display: flex; flex-direction: column; gap: 8px;}
    .row {display: flex; gap: 6px;}
    #chat-input {padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; flex: 1;}
    button {padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;}
    #change-name-btn {background: #007bff;}
    #delete-all-btn {background: #e53935;}
</style>
</head>
<body>

<div id="messages"></div>

<div id="input-area">
    <div class="row">
        <input type="text" id="chat-input" maxlength="200" placeholder="Tulis pesan (max 200 karakter)...">
        <button id="send-btn">Kirim</button>
    </div>
    <button id="change-name-btn">Ganti Nama</button>
    <label>Volume: <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.5"></label>
    <label>Pilih Nada Dering: <input type="file" id="sound-file" accept=".mp3,.ogg,.wav"></label>
    <button id="delete-all-btn">Hapus Semua Chat</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBFxx4epV2oRNLJJ4n2kBIQ0RusjUsXDX0",
      authDomain: "chat-santai-89927.firebaseapp.com",
      databaseURL: "https://chat-santai-89927-default-rtdb.firebaseio.com",
      projectId: "chat-santai-89927",
      storageBucket: "chat-santai-89927.firebasestorage.app",
      messagingSenderId: "681846167278",
      appId: "1:681846167278:web:ae3ba2540c43901fbd45ff"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "messages");

    let username = localStorage.getItem("chat_username");
    while (!username || username.trim() === "") {
        username = prompt("Masukkan nama kamu untuk mulai chat:");
    }
    username = username.trim();
    localStorage.setItem("chat_username", username);

    document.getElementById("change-name-btn").addEventListener("click", () => {
        let newName = prompt("Masukkan nama baru:", username);
        if (newName && newName.trim() !== "") {
            username = newName.trim();
            localStorage.setItem("chat_username", username);
            alert("Nama berhasil diganti menjadi: " + username);
        }
    });

    let notifSound = null;
    let volume = 0.5;
    document.getElementById("volume-control").addEventListener("input", e => volume = parseFloat(e.target.value));
    document.getElementById("sound-file").addEventListener("change", e => {
        const file = e.target.files[0];
        if (file) notifSound = new Audio(URL.createObjectURL(file));
    });

    let lastSendTime = 0; // untuk anti-spam
    function sendMessage() {
        const now = Date.now();
        if (now - lastSendTime < 5000) { // 5 detik
            alert("Tunggu beberapa detik sebelum kirim lagi.");
            return;
        }
        let text = document.getElementById("chat-input").value.trim();
        if (text.length > 200) text = text.substring(0, 200);
        if (text) {
            push(messagesRef, {
                name: username,
                text: text,
                time: Date.now()
            });
            document.getElementById("chat-input").value = "";
            lastSendTime = now;
        }
    }
    document.getElementById("send-btn").addEventListener("click", sendMessage);
    document.getElementById("chat-input").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function formatTime(ts) {
        const d = new Date(ts);
        return d.getHours().toString().padStart(2,"0") + ":" + d.getMinutes().toString().padStart(2,"0");
    }

    onChildAdded(messagesRef, (data) => {
        const msg = data.val();
        const div = document.createElement("div");
        div.className = "message";
        if (msg.name === username) div.classList.add("my-message");
        div.innerHTML = `<strong>${msg.name || "Anonim"}:</strong> ${msg.text}<span class="msg-time">${formatTime(msg.time)}</span>`;

        // Long press delete
        let pressTimer;
        const startPress = () => {
            pressTimer = setTimeout(() => {
                if (confirm("Hapus pesan ini?")) remove(ref(db, "messages/" + data.key));
            }, 800);
        };
        const cancelPress = () => clearTimeout(pressTimer);

        div.addEventListener("pointerdown", startPress);
        div.addEventListener("pointerup", cancelPress);
        div.addEventListener("pointerleave", cancelPress);

        document.getElementById("messages").appendChild(div);
        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
        if (notifSound) { notifSound.volume = volume; notifSound.play().catch(() => {}); }
    });

    // Mass delete
    document.getElementById("delete-all-btn").addEventListener("click", () => {
        if (confirm("Yakin mau hapus semua pesan?") && confirm("Konfirmasi lagi: hapus semua pesan?")) {
            remove(messagesRef).then(() => {
                document.getElementById("messages").innerHTML = "";
            });
        }
    });

    // Auto-delete if > 20 messages
    onValue(messagesRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            const keys = Object.keys(data);
            if (keys.length > 20) {
                const oldestKey = keys[0];
                remove(ref(db, "messages/" + oldestKey));
            }
        }
    });
</script>

</body>
</html>
